"""
AIæŠ•è³‡åˆ†æå„€ - APIä¼ºæœå™¨ v2.0
æ•´åˆDatabaseConnectorçš„å®Œæ•´ç‰ˆAPIä¼ºæœå™¨
"""

from flask import Flask, jsonify, request
from flask_cors import CORS
from data_loader import DatabaseConnector
from datetime import datetime, timedelta
import os
from dotenv import load_dotenv
from loguru import logger

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), 'config', '.env'))

# åˆå§‹åŒ–Flaskæ‡‰ç”¨
app = Flask(__name__)
CORS(app)

# åˆå§‹åŒ–DatabaseConnector
db = DatabaseConnector()

# ============ å¥åº·æª¢æŸ¥ ============
@app.route('/api/health', methods=['GET'])
def health_check():
    """å¥åº·æª¢æŸ¥ç«¯é»"""
    db_status = db.test_connection()
    
    return jsonify({
        'status': 'healthy' if db_status else 'unhealthy',
        'timestamp': datetime.now().isoformat(),
        'version': '2.0.0',
        'database': {
            'connected': db_status,
            'name': os.getenv('DB_NAME', 'quant_db')
        },
        'message': 'APIä¼ºæœå™¨v2é‹è¡Œä¸­ï¼ˆæ•´åˆDatabaseConnectorï¼‰'
    })

# ============ APIé…ç½®ç®¡ç† ============
@app.route('/api/config/sync-api-keys', methods=['POST'])
def sync_api_keys():
    """åŒæ­¥APIé‡‘é‘°åˆ°å¾Œç«¯é…ç½®"""
    try:
        data = request.get_json()
        
        if not data:
            return jsonify({'success': False, 'message': 'ç„¡æ•ˆçš„è«‹æ±‚'}), 400
        
        # æ›´æ–°.envæª”æ¡ˆ
        env_path = os.path.join(os.path.dirname(__file__), 'config', '.env')
        updated_keys = []
        
        # è®€å–ç¾æœ‰.env
        env_vars = {}
        if os.path.exists(env_path):
            with open(env_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and '=' in line and not line.startswith('#'):
                        key, value = line.split('=', 1)
                        env_vars[key] = value
        
        # APIé‡‘é‘°æ˜ å°„
        key_mapping = {
            'gemini': 'GEMINI_API_KEY',
            'alphaVantage': 'ALPHA_VANTAGE_API_KEY',
            'tiingo': 'TIINGO_API_KEY',
            'finnhub': 'FINNHUB_API_KEY',
            'fred': 'FRED_API_KEY',
            'fmp': 'FMP_API_KEY',
            'goldApi': 'GOLD_API_KEY',
            'exchangeRate': 'EXCHANGE_RATE_API_KEY',
            'marketaux': 'MARKETAUX_API_KEY'
        }
        
        # æ›´æ–°APIé‡‘é‘°
        for frontend_key, backend_key in key_mapping.items():
            if frontend_key in data and data[frontend_key]:
                env_vars[backend_key] = data[frontend_key]
                updated_keys.append(frontend_key)
        
        # å¯«å›.envæª”æ¡ˆ
        with open(env_path, 'w', encoding='utf-8') as f:
            for key, value in env_vars.items():
                f.write(f'{key}={value}\n')
        
        # é‡æ–°è¼‰å…¥ç’°å¢ƒè®Šæ•¸
        load_dotenv(env_path, override=True)
        
        logger.info(f"âœ… æˆåŠŸåŒæ­¥ {len(updated_keys)} å€‹APIé‡‘é‘°")
        
        return jsonify({
            'success': True,
            'message': f'æˆåŠŸåŒæ­¥{len(updated_keys)}å€‹APIé‡‘é‘°',
            'synced_keys': updated_keys
        })
        
    except Exception as e:
        logger.error(f"âŒ åŒæ­¥å¤±æ•—: {str(e)}")
        return jsonify({
            'success': False,
            'message': f'åŒæ­¥å¤±æ•—: {str(e)}'
        }), 500


@app.route('/api/config/api-keys', methods=['GET'])
def get_api_keys_status():
    """ç²å–APIé‡‘é‘°é…ç½®ç‹€æ…‹"""
    try:
        keys_status = {}
        
        # APIé‡‘é‘°æ˜ å°„
        key_mapping = {
            'gemini': 'GEMINI_API_KEY',
            'alphaVantage': 'ALPHA_VANTAGE_API_KEY',
            'tiingo': 'TIINGO_API_KEY',
            'finnhub': 'FINNHUB_API_KEY',
            'fred': 'FRED_API_KEY',
            'fmp': 'FMP_API_KEY',
            'goldApi': 'GOLD_API_KEY',
            'exchangeRate': 'EXCHANGE_RATE_API_KEY',
            'marketaux': 'MARKETAUX_API_KEY'
        }
        
        # æª¢æŸ¥æ¯å€‹keyçš„é…ç½®ç‹€æ…‹
        for frontend_key, backend_key in key_mapping.items():
            api_key = os.getenv(backend_key, '')
            is_configured = (api_key and 
                           'your_' not in api_key.lower() and 
                           '_here' not in api_key.lower() and
                           len(api_key) > 10)
            
            if is_configured:
                keys_status[frontend_key] = {
                    'configured': True,
                    'masked_key': api_key[:6] + '***' if len(api_key) > 6 else '***'
                }
            else:
                keys_status[frontend_key] = {
                    'configured': False
                }
        
        return jsonify(keys_status)
        
    except Exception as e:
        logger.error(f"âŒ ç²å–APIé‡‘é‘°ç‹€æ…‹å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500

# ============ è³‡æ–™åº«æŸ¥è©¢ ============
@app.route('/api/database/tables', methods=['GET'])
def get_tables():
    """åˆ—å‡ºæ‰€æœ‰è³‡æ–™è¡¨"""
    try:
        tables = db.execute_query("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public'
            ORDER BY table_name
        """)
        
        return jsonify({
            'count': len(tables),
            'tables': [t['table_name'] for t in tables]
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–è¡¨æ ¼æ¸…å–®å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/database/table/<table_name>', methods=['GET'])
def get_table_data(table_name):
    """æŸ¥è©¢è¡¨æ ¼è³‡æ–™"""
    try:
        limit = request.args.get('limit', 100, type=int)
        offset = request.args.get('offset', 0, type=int)
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        tables = db.execute_query("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' AND table_name = %s
        """, (table_name,))
        
        if not tables:
            return jsonify({'error': f'è¡¨æ ¼ {table_name} ä¸å­˜åœ¨'}), 404
        
        # æŸ¥è©¢è³‡æ–™
        data = db.execute_query(f"""
            SELECT * FROM {table_name}
            ORDER BY 1 DESC
            LIMIT %s OFFSET %s
        """, (limit, offset))
        
        # ç²å–ç¸½æ•¸
        count_result = db.execute_query(f"SELECT COUNT(*) as total FROM {table_name}")
        total = count_result[0]['total'] if count_result else 0
        
        return jsonify({
            'table': table_name,
            'total': total,
            'limit': limit,
            'offset': offset,
            'count': len(data),
            'data': data
        })
    except Exception as e:
        logger.error(f"âŒ æŸ¥è©¢è¡¨æ ¼è³‡æ–™å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500

# ============ è‚¡ç¥¨è³‡è¨Š ============
@app.route('/api/stocks/list', methods=['GET'])
def get_stocks_list():
    """ç²å–è‚¡ç¥¨æ¸…å–®"""
    try:
        market = request.args.get('market', 'tw')
        limit = request.args.get('limit', 100, type=int)
        
        table = 'tw_stock_info' if market == 'tw' else 'us_stock_info'
        
        stocks = db.execute_query(f"""
            SELECT stock_code, stock_name, industry, market
            FROM {table}
            ORDER BY stock_code
            LIMIT %s
        """, (limit,))
        
        return jsonify({
            'market': market,
            'count': len(stocks),
            'stocks': stocks
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–è‚¡ç¥¨æ¸…å–®å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/stocks/search', methods=['GET'])
def search_stocks():
    """æœå°‹è‚¡ç¥¨"""
    try:
        query = request.args.get('q', '')
        market = request.args.get('market', 'tw')
        
        if not query:
            return jsonify({'error': 'è«‹æä¾›æœå°‹é—œéµå­—'}), 400
        
        table = 'tw_stock_info' if market == 'tw' else 'us_stock_info'
        
        results = db.execute_query(f"""
            SELECT stock_code, stock_name, industry, market
            FROM {table}
            WHERE stock_code LIKE %s OR stock_name LIKE %s
            LIMIT 20
        """, (f'%{query}%', f'%{query}%'))
        
        return jsonify({
            'query': query,
            'market': market,
            'count': len(results),
            'results': results
        })
    except Exception as e:
        logger.error(f"âŒ æœå°‹è‚¡ç¥¨å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/stocks/<stock_code>', methods=['GET'])
def get_stock_info(stock_code):
    """ç²å–å€‹è‚¡è©³ç´°è³‡è¨Š"""
    try:
        market = request.args.get('market', 'tw')
        table = 'tw_stock_info' if market == 'tw' else 'us_stock_info'
        
        info = db.execute_query(f"""
            SELECT * FROM {table}
            WHERE stock_code = %s
        """, (stock_code,), fetch_one=True)
        
        if not info:
            return jsonify({'error': f'æ‰¾ä¸åˆ°è‚¡ç¥¨ {stock_code}'}), 404
        
        return jsonify(info)
    except Exception as e:
        logger.error(f"âŒ ç²å–è‚¡ç¥¨è³‡è¨Šå¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500

# ============ åƒ¹æ ¼è³‡æ–™ ============
@app.route('/api/prices/<stock_code>', methods=['GET'])
def get_stock_prices(stock_code):
    """ç²å–è‚¡ç¥¨åƒ¹æ ¼è³‡æ–™"""
    try:
        market = request.args.get('market', 'tw')
        days = request.args.get('days', 30, type=int)
        start_date = request.args.get('start_date')
        end_date = request.args.get('end_date')
        
        table = 'tw_stock_prices' if market == 'tw' else 'us_stock_prices'
        
        # æ§‹å»ºæŸ¥è©¢
        if start_date and end_date:
            prices = db.execute_query(f"""
                SELECT trade_date, open_price, high_price, low_price, 
                       close_price, volume, adjusted_close
                FROM {table}
                WHERE stock_code = %s 
                AND trade_date BETWEEN %s AND %s
                ORDER BY trade_date DESC
            """, (stock_code, start_date, end_date))
        else:
            prices = db.execute_query(f"""
                SELECT trade_date, open_price, high_price, low_price, 
                       close_price, volume, adjusted_close
                FROM {table}
                WHERE stock_code = %s
                ORDER BY trade_date DESC
                LIMIT %s
            """, (stock_code, days))
        
        return jsonify({
            'stock_code': stock_code,
            'market': market,
            'count': len(prices),
            'data': prices
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–åƒ¹æ ¼è³‡æ–™å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/prices/<stock_code>/latest', methods=['GET'])
def get_latest_price(stock_code):
    """ç²å–æœ€æ–°åƒ¹æ ¼"""
    try:
        market = request.args.get('market', 'tw')
        table = 'tw_stock_prices' if market == 'tw' else 'us_stock_prices'
        
        latest = db.execute_query(f"""
            SELECT * FROM {table}
            WHERE stock_code = %s
            ORDER BY trade_date DESC
            LIMIT 1
        """, (stock_code,), fetch_one=True)
        
        if not latest:
            return jsonify({'error': f'æ‰¾ä¸åˆ° {stock_code} çš„åƒ¹æ ¼è³‡æ–™'}), 404
        
        return jsonify(latest)
    except Exception as e:
        logger.error(f"âŒ ç²å–æœ€æ–°åƒ¹æ ¼å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500

# ============ å› å­åˆ†æ•¸ ============
@app.route('/api/factors/<stock_code>', methods=['GET'])
def get_factor_scores(stock_code):
    """ç²å–è‚¡ç¥¨å› å­åˆ†æ•¸"""
    try:
        market = request.args.get('market', 'tw')
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'quant_scores'
        """)
        
        if not table_check:
            logger.warning("âš ï¸ quant_scoresè¡¨æ ¼ä¸å­˜åœ¨")
            return jsonify({
                'error': 'å› å­åˆ†æ•¸åŠŸèƒ½å°šæœªå•Ÿç”¨',
                'message': 'è«‹å…ˆåŸ·è¡Œå› å­è¨ˆç®—ä»¥ç”Ÿæˆæ•¸æ“š'
            }), 404
        
        # æŸ¥è©¢æœ€æ–°çš„å› å­åˆ†æ•¸
        scores = db.execute_query("""
            SELECT * FROM quant_scores
            WHERE security_code = %s AND security_type = %s
            ORDER BY calculation_date DESC
            LIMIT 1
        """, (stock_code, market.upper()), fetch_one=True)
        
        if not scores:
            return jsonify({
                'error': f'æ‰¾ä¸åˆ° {stock_code} çš„å› å­åˆ†æ•¸',
                'stock_code': stock_code,
                'market': market
            }), 404
        
        return jsonify(scores)
    except Exception as e:
        logger.error(f"âŒ ç²å–å› å­åˆ†æ•¸å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢å› å­åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


@app.route('/api/factors/<stock_code>/history', methods=['GET'])
def get_factor_history(stock_code):
    """ç²å–è‚¡ç¥¨å› å­æ­·å²"""
    try:
        market = request.args.get('market', 'tw')
        days = request.args.get('days', 90, type=int)
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'quant_scores'
        """)
        
        if not table_check:
            return jsonify({
                'stock_code': stock_code,
                'market': market,
                'count': 0,
                'data': [],
                'message': 'å› å­åˆ†æ•¸åŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢æ­·å²å› å­åˆ†æ•¸
        history = db.execute_query("""
            SELECT * FROM quant_scores
            WHERE security_code = %s AND security_type = %s
            ORDER BY calculation_date DESC
            LIMIT %s
        """, (stock_code, market.upper(), days))
        
        return jsonify({
            'stock_code': stock_code,
            'market': market,
            'count': len(history),
            'data': history
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–å› å­æ­·å²å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢å› å­æ­·å²æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ TDCCè‚¡æ¬Šæ•¸æ“š ============
@app.route('/api/tdcc/<stock_code>', methods=['GET'])
def get_tdcc_data(stock_code):
    """ç²å–TDCCè‚¡æ¬Šåˆ†æ•£è¡¨æ•¸æ“š"""
    try:
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'tdcc_shareholder_dispersion'
        """)
        
        if not table_check:
            return jsonify({
                'stock_code': stock_code,
                'count': 0,
                'data': [],
                'message': 'TDCCæ•¸æ“šå°šæœªåŒæ­¥'
            })
        
        # æŸ¥è©¢æœ€æ–°çš„TDCCæ•¸æ“š
        tdcc_data = db.execute_query("""
            SELECT * FROM tdcc_shareholder_dispersion
            WHERE stock_code = %s
            ORDER BY data_date DESC
            LIMIT 10
        """, (stock_code,))
        
        if not tdcc_data:
            return jsonify({
                'stock_code': stock_code,
                'count': 0,
                'data': [],
                'message': f'æ‰¾ä¸åˆ° {stock_code} çš„TDCCæ•¸æ“š'
            })
        
        return jsonify({
            'stock_code': stock_code,
            'count': len(tdcc_data),
            'data': tdcc_data
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–TDCCæ•¸æ“šå¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢TDCCæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ æŠ€è¡“æŒ‡æ¨™ ============
@app.route('/api/indicators/<stock_code>', methods=['GET'])
def get_technical_indicators(stock_code):
    """ç²å–æŠ€è¡“æŒ‡æ¨™æ•¸æ“š"""
    try:
        market = request.args.get('market', 'tw')
        days = request.args.get('days', 30, type=int)
        
        table = 'tw_technical_indicators' if market == 'tw' else 'us_technical_indicators'
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = %s
        """, (table,))
        
        if not table_check:
            return jsonify({
                'stock_code': stock_code,
                'market': market,
                'count': 0,
                'data': [],
                'message': 'æŠ€è¡“æŒ‡æ¨™æ•¸æ“šå°šæœªè¨ˆç®—'
            })
        
        # æŸ¥è©¢æŠ€è¡“æŒ‡æ¨™
        indicators = db.execute_query(f"""
            SELECT * FROM {table}
            WHERE stock_code = %s
            ORDER BY calculation_date DESC
            LIMIT %s
        """, (stock_code, days))
        
        return jsonify({
            'stock_code': stock_code,
            'market': market,
            'count': len(indicators),
            'data': indicators,
            'message': 'æˆåŠŸ' if indicators else f'æ‰¾ä¸åˆ° {stock_code} çš„æŠ€è¡“æŒ‡æ¨™æ•¸æ“š'
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–æŠ€è¡“æŒ‡æ¨™å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢æŠ€è¡“æŒ‡æ¨™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ AIå ±å‘Š ============
@app.route('/api/ai/reports', methods=['GET'])
def get_ai_reports():
    """ç²å–AIå ±å‘Šåˆ—è¡¨"""
    try:
        limit = request.args.get('limit', 10, type=int)
        report_type = request.args.get('type', 'daily')
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'ai_reports'
        """)
        
        if not table_check:
            return jsonify({
                'type': report_type,
                'count': 0,
                'reports': [],
                'message': 'AIå ±å‘ŠåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢AIå ±å‘Š
        reports = db.execute_query("""
            SELECT id, report_type, security_type, security_code, 
                   title, content, created_at
            FROM ai_reports
            WHERE report_type = %s
            ORDER BY created_at DESC
            LIMIT %s
        """, (report_type, limit))
        
        return jsonify({
            'type': report_type,
            'count': len(reports),
            'reports': reports
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–AIå ±å‘Šå¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢AIå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


@app.route('/api/ai/report/<report_id>', methods=['GET'])
def get_ai_report_detail(report_id):
    """ç²å–AIå ±å‘Šè©³æƒ…"""
    try:
        # é©—è­‰report_idæ˜¯å¦ç‚ºæ•¸å­—
        try:
            report_id_int = int(report_id)
        except ValueError:
            return jsonify({
                'error': 'ç„¡æ•ˆçš„å ±å‘ŠID',
                'message': 'å ±å‘ŠIDå¿…é ˆæ˜¯æ•¸å­—'
            }), 404
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'ai_reports'
        """)
        
        if not table_check:
            return jsonify({
                'error': 'æ‰¾ä¸åˆ°å ±å‘Š',
                'message': 'AIå ±å‘ŠåŠŸèƒ½å°šæœªå•Ÿç”¨'
            }), 404
        
        # æŸ¥è©¢å ±å‘Šè©³æƒ…
        report = db.execute_query("""
            SELECT * FROM ai_reports
            WHERE id = %s
        """, (report_id_int,), fetch_one=True)
        
        if not report:
            return jsonify({'error': f'æ‰¾ä¸åˆ°å ±å‘ŠID {report_id}'}), 404
        
        return jsonify(report)
    except Exception as e:
        logger.error(f"âŒ ç²å–AIå ±å‘Šè©³æƒ…å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢AIå ±å‘Šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ æŠ•è³‡çµ„åˆ ============
@app.route('/api/portfolio/list', methods=['GET'])
def get_portfolios():
    """ç²å–æŠ•è³‡çµ„åˆåˆ—è¡¨"""
    try:
        user_id = request.args.get('user_id', 1, type=int)
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'user_portfolios'
        """)
        
        if not table_check:
            return jsonify({
                'user_id': user_id,
                'count': 0,
                'portfolios': [],
                'message': 'æŠ•è³‡çµ„åˆåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢æŠ•è³‡çµ„åˆ
        portfolios = db.execute_query("""
            SELECT portfolio_id, portfolio_name, total_value, 
                   created_at, updated_at
            FROM user_portfolios
            WHERE user_id = %s
            ORDER BY updated_at DESC
        """, (user_id,))
        
        return jsonify({
            'user_id': user_id,
            'count': len(portfolios),
            'portfolios': portfolios
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–æŠ•è³‡çµ„åˆåˆ—è¡¨å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢æŠ•è³‡çµ„åˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


@app.route('/api/portfolio/<portfolio_id>/holdings', methods=['GET'])
def get_portfolio_holdings(portfolio_id):
    """ç²å–æŠ•è³‡çµ„åˆæŒå€‰"""
    try:
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'portfolio_holdings'
        """)
        
        if not table_check:
            return jsonify({
                'portfolio_id': portfolio_id,
                'count': 0,
                'holdings': [],
                'message': 'æŠ•è³‡çµ„åˆåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢æŒå€‰
        holdings = db.execute_query("""
            SELECT h.*, s.stock_name, s.industry
            FROM portfolio_holdings h
            LEFT JOIN tw_stock_info s ON h.stock_code = s.stock_code
            WHERE h.portfolio_id = %s AND h.shares > 0
            ORDER BY h.market_value DESC
        """, (portfolio_id,))
        
        return jsonify({
            'portfolio_id': portfolio_id,
            'count': len(holdings),
            'holdings': holdings
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–æŒå€‰å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢æŒå€‰æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ éŒ¯èª¤è™•ç† ============
@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'APIç«¯é»ä¸å­˜åœ¨'}), 404


@app.errorhandler(500)
def internal_error(error):
    return jsonify({'error': 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'}), 500

# ============ ä¸»ç¨‹å¼ ============
if __name__ == '__main__':
    port = int(os.getenv('API_PORT', 5000))
    
    logger.info("=" * 60)
    logger.info("ğŸš€ APIä¼ºæœå™¨ v2.0 å•Ÿå‹•")
    logger.info("=" * 60)
    logger.info(f"ğŸ“¡ æœå‹™ç¶²å€: http://localhost:{port}")
    logger.info(f"ğŸ’¾ è³‡æ–™åº«: {os.getenv('DB_NAME')}@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}")
    logger.info(f"âœ¨ æ•´åˆ: DatabaseConnector")
    logger.info("=" * 60)
    logger.info("ğŸ“‹ å¯ç”¨ç«¯é»ï¼ˆå…±19å€‹ï¼‰:")
    logger.info("   [å¥åº·æª¢æŸ¥]")
    logger.info("     GET  /api/health")
    logger.info("   [APIé…ç½®]")
    logger.info("     GET  /api/config/api-keys")
    logger.info("     POST /api/config/sync-api-keys")
    logger.info("   [è³‡æ–™åº«]")
    logger.info("     GET  /api/database/tables")
    logger.info("     GET  /api/database/table/<name>")
    logger.info("   [è‚¡ç¥¨è³‡è¨Š]")
    logger.info("     GET  /api/stocks/list")
    logger.info("     GET  /api/stocks/search")
    logger.info("     GET  /api/stocks/<code>")
    logger.info("   [åƒ¹æ ¼è³‡æ–™]")
    logger.info("     GET  /api/prices/<code>")
    logger.info("     GET  /api/prices/<code>/latest")
    logger.info("   [å› å­åˆ†æ•¸]")
    logger.info("     GET  /api/factors/<code>")
    logger.info("     GET  /api/factors/<code>/history")
    logger.info("   [TDCCæ•¸æ“š]")
```python
        limit = request.args.get('limit', 10, type=int)
        report_type = request.args.get('type', 'daily')
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'ai_reports'
        """)
        
        if not table_check:
            return jsonify({
                'type': report_type,
                'count': 0,
                'reports': [],
                'message': 'AIå ±å‘ŠåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢AIå ±å‘Š
        reports = db.execute_query("""
            SELECT id, report_type, security_type, security_code, 
                   title, content, created_at
            FROM ai_reports
            WHERE report_type = %s
            ORDER BY created_at DESC
            LIMIT %s
        """, (report_type, limit))
        
        return jsonify({
            'type': report_type,
            'count': len(reports),
            'reports': reports
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–AIå ±å‘Šå¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢AIå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


@app.route('/api/ai/report/<report_id>', methods=['GET'])
def get_ai_report_detail(report_id):
    """ç²å–AIå ±å‘Šè©³æƒ…"""
    try:
        # é©—è­‰report_idæ˜¯å¦ç‚ºæ•¸å­—
        try:
            report_id_int = int(report_id)
        except ValueError:
            return jsonify({
                'error': 'ç„¡æ•ˆçš„å ±å‘ŠID',
                'message': 'å ±å‘ŠIDå¿…é ˆæ˜¯æ•¸å­—'
            }), 404
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'ai_reports'
        """)
        
        if not table_check:
            return jsonify({
                'error': 'æ‰¾ä¸åˆ°å ±å‘Š',
                'message': 'AIå ±å‘ŠåŠŸèƒ½å°šæœªå•Ÿç”¨'
            }), 404
        
        # æŸ¥è©¢å ±å‘Šè©³æƒ…
        report = db.execute_query("""
            SELECT * FROM ai_reports
            WHERE id = %s
        """, (report_id_int,), fetch_one=True)
        
        if not report:
            return jsonify({'error': f'æ‰¾ä¸åˆ°å ±å‘ŠID {report_id}'}), 404
        
        return jsonify(report)
    except Exception as e:
        logger.error(f"âŒ ç²å–AIå ±å‘Šè©³æƒ…å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢AIå ±å‘Šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ æŠ•è³‡çµ„åˆ ============
@app.route('/api/portfolio/list', methods=['GET'])
def get_portfolios():
    """ç²å–æŠ•è³‡çµ„åˆåˆ—è¡¨"""
    try:
        user_id = request.args.get('user_id', 1, type=int)
        
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'user_portfolios'
        """)
        
        if not table_check:
            return jsonify({
                'user_id': user_id,
                'count': 0,
                'portfolios': [],
                'message': 'æŠ•è³‡çµ„åˆåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢æŠ•è³‡çµ„åˆ
        portfolios = db.execute_query("""
            SELECT portfolio_id, portfolio_name, total_value, 
                   created_at, updated_at
            FROM user_portfolios
            WHERE user_id = %s
            ORDER BY updated_at DESC
        """, (user_id,))
        
        return jsonify({
            'user_id': user_id,
            'count': len(portfolios),
            'portfolios': portfolios
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–æŠ•è³‡çµ„åˆåˆ—è¡¨å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢æŠ•è³‡çµ„åˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


@app.route('/api/portfolio/<portfolio_id>/holdings', methods=['GET'])
def get_portfolio_holdings(portfolio_id):
    """ç²å–æŠ•è³‡çµ„åˆæŒå€‰"""
    try:
        # æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        table_check = db.execute_query("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'portfolio_holdings'
        """)
        
        if not table_check:
            return jsonify({
                'portfolio_id': portfolio_id,
                'count': 0,
                'holdings': [],
                'message': 'æŠ•è³‡çµ„åˆåŠŸèƒ½å°šæœªå•Ÿç”¨'
            })
        
        # æŸ¥è©¢æŒå€‰
        holdings = db.execute_query("""
            SELECT h.*, s.stock_name, s.industry
            FROM portfolio_holdings h
            LEFT JOIN tw_stock_info s ON h.stock_code = s.stock_code
            WHERE h.portfolio_id = %s AND h.shares > 0
            ORDER BY h.market_value DESC
        """, (portfolio_id,))
        
        return jsonify({
            'portfolio_id': portfolio_id,
            'count': len(holdings),
            'holdings': holdings
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–æŒå€‰å¤±æ•—: {str(e)}")
        return jsonify({'error': 'æŸ¥è©¢æŒå€‰æ™‚ç™¼ç”ŸéŒ¯èª¤', 'details': str(e)}), 500


# ============ éŒ¯èª¤è™•ç† ============
@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'APIç«¯é»ä¸å­˜åœ¨'}), 404


@app.errorhandler(500)
def internal_error(error):
    return jsonify({'error': 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'}), 500


# ============ æ–°å¢ï¼šå•†å“åƒ¹æ ¼ï¼ˆé»ƒé‡‘ç­‰ï¼‰ ============
@app.route('/api/commodity/<commodity_code>', methods=['GET'])
def get_commodity_prices(commodity_code):
    """ç²å–å•†å“åƒ¹æ ¼ï¼ˆé»ƒé‡‘ç­‰ï¼‰"""
    try:
        days = request.args.get('days', 30, type=int)
        
        prices = db.execute_query("""
            SELECT trade_date, close_price, volume
            FROM commodity_prices
            WHERE commodity_code = %s
            ORDER BY trade_date DESC
            LIMIT %s
        """, (commodity_code.upper(), days))
        
        return jsonify({
            'commodity': commodity_code,
            'count': len(prices),
            'data': prices
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–å•†å“åƒ¹æ ¼å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============ æ–°å¢ï¼šåŒ¯ç‡æŸ¥è©¢ ============
@app.route('/api/forex/<pair>', methods=['GET'])
def get_forex_rates(pair):
    """ç²å–åŒ¯ç‡ï¼ˆUSD/TWDç­‰ï¼‰"""
    try:
        days = request.args.get('days', 30, type=int)
        
        # è§£æè²¨å¹£å° (æ ¼å¼: USDTWD)
        if len(pair) != 6:
            return jsonify({'error': 'ç„¡æ•ˆçš„è²¨å¹£å°æ ¼å¼ï¼Œæ‡‰ç‚ºXXXYYY'}), 400
        
        base = pair[:3].upper()
        quote = pair[3:].upper()
        
        rates = db.execute_query("""
            SELECT trade_date, rate
            FROM exchange_rates
            WHERE base_currency = %s AND quote_currency = %s
            ORDER BY trade_date DESC
            LIMIT %s
        """, (base, quote, days))
        
        return jsonify({
            'pair': f'{base}/{quote}',
            'count': len(rates),
            'data': rates
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–åŒ¯ç‡å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============ æ–°å¢ï¼šTDCCå¤§æˆ¶æŒè‚¡ ============
@app.route('/api/tdcc/<stock_code>', methods=['GET'])
def get_tdcc_data_endpoint(stock_code):
    """ç²å–TDCCå¤§æˆ¶æŒè‚¡æ•¸æ“š"""
    try:
        limit = request.args.get('limit', 10, type=int)
        
        tdcc_data = db.execute_query("""
            SELECT data_date, large_holder_ratio, total_shares,
                   holder_count_400k_plus, shares_400k_plus
            FROM tdcc_shareholder_dispersion
            WHERE stock_code = %s
            ORDER BY data_date DESC
            LIMIT %s
        """, (stock_code, limit))
        
        if not tdcc_data:
            return jsonify({
                'stock_code': stock_code,
                'count': 0,
                'data': [],
                'message': 'ç„¡TDCCæ•¸æ“š'
            })
        
        return jsonify({
            'stock_code': stock_code,
            'count': len(tdcc_data),
            'data': tdcc_data
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–TDCCæ•¸æ“šå¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============ æ–°å¢ï¼šå¸‚å ´ç¸½è¦½ ============
@app.route('/api/market/summary', methods=['GET'])
def get_market_summary():
    """ç²å–å¸‚å ´ç¸½è¦½ï¼ˆé»ƒé‡‘ã€åŒ¯ç‡ã€æƒ…ç·’æŒ‡æ¨™ï¼‰"""
    try:
        # æœ€æ–°é»ƒé‡‘åƒ¹æ ¼
        gold = db.execute_query("""
            SELECT close_price, trade_date
            FROM commodity_prices
            WHERE commodity_code = 'GOLD'
            ORDER BY trade_date DESC
            LIMIT 1
        """, fetch_one=True)
        
        # æœ€æ–°ç¾å…ƒå°å¹£åŒ¯ç‡
        usdtwd = db.execute_query("""
            SELECT rate, trade_date
            FROM exchange_rates
            WHERE base_currency = 'USD' AND quote_currency = 'TWD'
            ORDER BY trade_date DESC
            LIMIT 1
        """, fetch_one=True)
        
        # å°è‚¡çµ±è¨ˆ
        tw_stocks = db.execute_query("""
            SELECT COUNT(*) as count FROM tw_stock_info
        """, fetch_one=True)
        
        # ç¾è‚¡çµ±è¨ˆ
        us_stocks = db.execute_query("""
            SELECT COUNT(*) as count FROM us_stock_info
        """, fetch_one=True)
        
        return jsonify({
            'gold': {
                'price': float(gold['close_price']) if gold else None,
                'date': str(gold['trade_date']) if gold else None
            },
            'forex': {
                'usd_twd': float(usdtwd['rate']) if usdtwd else None,
                'date': str(usdtwd['trade_date']) if usdtwd else None
            },
            'stocks': {
                'tw': tw_stocks['count'] if tw_stocks else 0,
                'us': us_stocks['count'] if us_stocks else 0
            }
        })
    except Exception as e:
        logger.error(f"âŒ ç²å–å¸‚å ´ç¸½è¦½å¤±æ•—: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============ ä¸»ç¨‹å¼ ============
if __name__ == '__main__':
    port = int(os.getenv('API_PORT', 5000))
    
    logger.info("=" * 60)
    logger.info("ğŸš€ APIä¼ºæœå™¨ v2.0 å•Ÿå‹•")
    logger.info("=" * 60)
    logger.info(f"ğŸ“¡ æœå‹™ç¶²å€: http://localhost:{port}")
    logger.info(f"ğŸ’¾ è³‡æ–™åº«: {os.getenv('DB_NAME')}@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}")
    logger.info(f"âœ¨ æ•´åˆ: DatabaseConnector")
    logger.info("=" * 60)
    logger.info("ğŸ“‹ å¯ç”¨ç«¯é»ï¼ˆå…±23å€‹ï¼‰:")
    logger.info("   [å¥åº·æª¢æŸ¥]")
    logger.info("     GET  /api/health")
    logger.info("   [APIé…ç½®]")
    logger.info("     GET  /api/config/api-keys")
    logger.info("     POST /api/config/sync-api-keys")
    logger.info("   [è³‡æ–™åº«]")
    logger.info("     GET  /api/database/tables")
    logger.info("     GET  /api/database/table/<name>")
    logger.info("   [è‚¡ç¥¨è³‡è¨Š]")
    logger.info("     GET  /api/stocks/list")
    logger.info("     GET  /api/stocks/search")
    logger.info("     GET  /api/stocks/<code>")
    logger.info("   [åƒ¹æ ¼è³‡æ–™]")
    logger.info("     GET  /api/prices/<code>")
    logger.info("     GET  /api/prices/<code>/latest")
    logger.info("   [å› å­åˆ†æ•¸]")
    logger.info("     GET  /api/factors/<code>")
    logger.info("     GET  /api/factors/<code>/history")
    logger.info("   [TDCCæ•¸æ“š]")
    logger.info("     GET  /api/tdcc/<code>")
    logger.info("   [æŠ€è¡“æŒ‡æ¨™]")
    logger.info("     GET  /api/indicators/<code>")
    logger.info("   [AIå ±å‘Š]")
    logger.info("     GET  /api/ai/reports")
    logger.info("     GET  /api/ai/report/<id>")
    logger.info("   [æŠ•è³‡çµ„åˆ]")
    logger.info("     GET  /api/portfolio/list")
    logger.info("     GET  /api/portfolio/<id>/holdings")
    logger.info("   [å•†å“åƒ¹æ ¼]")
    logger.info("     GET  /api/commodity/<code>")
    logger.info("   [åŒ¯ç‡æŸ¥è©¢]")
    logger.info("     GET  /api/forex/<pair>")
    logger.info("   [TDCCå¤§æˆ¶æŒè‚¡]")
    logger.info("     GET  /api/tdcc/<stock_code>")
    logger.info("   [å¸‚å ´ç¸½è¦½]")
    logger.info("     GET  /api/market/summary")
    logger.info("=" * 60)
    
    try:
        app.run(host='0.0.0.0', port=port, debug=True)
    finally:
        db.close()
        logger.info("âœ… è³‡æ–™åº«é€£æ¥å·²é—œé–‰")
```
